<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#3a86ff">
  <meta name="description" content="Inscription EARNESIA - Rejoignez notre plateforme d'opportunit√©s financi√®res">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  <title>EARNESIA - Inscription</title>
  
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* ===== VARIABLES ET DESIGN SYSTEM ===== */
    :root {
      /* Couleurs primaires */
      --primary: #3a86ff;
      --primary-dark: #2667cc;
      --primary-light: #6ba3ff;
      --secondary: #00b4d8;
      --accent: #00cc88;
      --warning: #ffd166;
      --danger: #ff6b6b;
      --success: #00cc88;
      
      /* Tons de gris */
      --light: #ffffff;
      --light-gray: #f8f9fa;
      --gray: #e9ecef;
      --dark-gray: #6c757d;
      --text: #333333;
      --text-light: #666666;
      
      /* √âl√©ments UI */
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 15px 40px rgba(58, 134, 255, 0.15);
      --shadow-elevated: 0 20px 60px rgba(0, 0, 0, 0.15);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --radius: 16px;
      --radius-sm: 8px;
      --radius-lg: 24px;
      
      /* Animation */
      --ease-out: cubic-bezier(0, 0, 0.2, 1);
      --ease-in: cubic-bezier(0.4, 0, 1, 1);
      --ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Dark mode variables */
    @media (prefers-color-scheme: dark) {
      :root {
        --light: #121826;
        --light-gray: #1e293b;
        --gray: #334155;
        --dark-gray: #94a3b8;
        --text: #f1f5f9;
        --text-light: #cbd5e1;
        --shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        --shadow-hover: 0 15px 40px rgba(58, 134, 255, 0.25);
      }
    }
    
    /* ===== RESET & BASE STYLES ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    html {
      scroll-behavior: smooth;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
      line-height: 1.6;
      font-size: 16px;
    }
    
    @media (prefers-color-scheme: dark) {
      body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      }
    }
    
    /* ===== ANIMATIONS PERFORMANTES ===== */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { transform: translateX(-20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      33% { transform: translateY(-10px) rotate(5deg); }
      66% { transform: translateY(5px) rotate(-5deg); }
    }
    
    @keyframes shimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }
    
    @keyframes ripple {
      to { transform: scale(4); opacity: 0; }
    }
    
    @keyframes progress {
      from { width: 100%; }
      to { width: 0%; }
    }
    
    @keyframes confetti {
      0% { transform: translateY(0) rotate(0deg); }
      100% { transform: translateY(100vh) rotate(720deg); }
    }
    
    /* ===== LAYOUT & CONTAINERS ===== */
    .container {
      width: 100%;
      max-width: 520px;
      margin: 0 auto;
      animation: fadeIn 0.8s var(--ease-out);
      will-change: transform, opacity;
    }
    
    /* ===== HEADER & BRANDING ===== */
    .logo-header {
      text-align: center;
      margin-bottom: 40px;
      position: relative;
    }
    
    .logo-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
      gap: 15px;
    }
    
    .logo-img {
      height: 80px;
      width: 80px;
      object-fit: contain;
      border-radius: 20px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      padding: 12px;
      box-shadow: var(--shadow);
      transition: var(--transition);
      will-change: transform;
    }
    
    .logo-img:hover {
      transform: scale(1.1) rotate(5deg);
      box-shadow: var(--shadow-hover);
    }
    
    .logo-text {
      font-size: 2.8rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-family: 'Poppins', sans-serif;
      letter-spacing: -0.5px;
      text-shadow: 0 2px 10px rgba(58, 134, 255, 0.2);
    }
    
    .tagline {
      font-size: 1.2rem;
      color: var(--dark-gray);
      font-weight: 500;
      position: relative;
      display: inline-block;
      padding: 0 30px;
    }
    
    .tagline::before,
    .tagline::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 40px;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--primary));
      transform: translateY(-50%);
    }
    
    .tagline::before {
      left: -10px;
    }
    
    .tagline::after {
      right: -10px;
      background: linear-gradient(90deg, var(--primary), transparent);
    }
    
    /* ===== MULTI-STEP FORM ===== */
    .form-progress {
      display: flex;
      justify-content: space-between;
      margin-bottom: 40px;
      position: relative;
      padding: 0 10px;
    }
    
    .form-progress::before {
      content: '';
      position: absolute;
      top: 15px;
      left: 10%;
      right: 10%;
      height: 2px;
      background: var(--gray);
      z-index: 1;
    }
    
    .progress-step {
      position: relative;
      z-index: 2;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--light);
      border: 2px solid var(--gray);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--dark-gray);
      font-weight: 600;
      font-size: 0.9rem;
      transition: var(--transition);
    }
    
    .progress-step.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
      transform: scale(1.1);
    }
    
    .progress-step.completed {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    
    .step-label {
      position: absolute;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.8rem;
      color: var(--dark-gray);
      white-space: nowrap;
    }
    
    /* ===== FORM SECTIONS ===== */
    .form-section {
      display: none;
      animation: fadeIn 0.5s var(--ease-out);
    }
    
    .form-section.active {
      display: block;
    }
    
    /* ===== CARD COMPONENT ===== */
    .card {
      background: var(--light);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      padding: 40px;
      position: relative;
      transition: var(--transition);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .card:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-2px);
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
      background-size: 200% 100%;
      animation: shimmer 3s infinite linear;
    }
    
    .card-header {
      text-align: center;
      margin-bottom: 35px;
    }
    
    .card-header h1 {
      color: var(--text);
      font-size: 1.9rem;
      font-weight: 700;
      margin-bottom: 10px;
      font-family: 'Poppins', sans-serif;
    }
    
    .card-header p {
      color: var(--dark-gray);
      font-size: 1.05rem;
      max-width: 80%;
      margin: 0 auto;
    }
    
    /* ===== FORM ELEMENTS ===== */
    .form-group {
      margin-bottom: 25px;
      animation: slideIn 0.5s var(--ease-out);
      animation-fill-mode: both;
      will-change: transform, opacity;
    }
    
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: var(--text);
      font-size: 0.95rem;
      transition: var(--transition);
      user-select: none;
    }
    
    .input-container {
      position: relative;
      isolation: isolate;
    }
    
    .input-group {
      display: flex;
      align-items: center;
      background: var(--light-gray);
      border-radius: var(--radius-sm);
      overflow: hidden;
      border: 2px solid var(--gray);
      transition: var(--transition);
      position: relative;
    }
    
    .input-group:focus-within {
      border-color: var(--primary);
      background: var(--light);
      box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.15);
      transform: translateY(-1px);
    }
    
    .input-group.error {
      border-color: var(--danger);
      animation: shake 0.5s;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    .input-icon {
      padding: 0 18px;
      color: var(--dark-gray);
      font-size: 1.1rem;
      min-width: 55px;
      text-align: center;
      transition: var(--transition);
    }
    
    input, select, textarea {
      width: 100%;
      padding: 18px 12px;
      border: none;
      background: transparent;
      color: var(--text);
      font-size: 1rem;
      font-weight: 500;
      outline: none;
      font-family: inherit;
      line-height: 1.5;
    }
    
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus {
      -webkit-box-shadow: 0 0 0px 1000px var(--light-gray) inset;
      -webkit-text-fill-color: var(--text);
      transition: background-color 5000s ease-in-out 0s;
    }
    
    .password-toggle {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--dark-gray);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: var(--transition);
      z-index: 2;
    }
    
    .password-toggle:hover {
      background: rgba(0, 0, 0, 0.05);
      color: var(--primary);
    }
    
    /* ===== PASSWORD STRENGTH ===== */
    .password-strength {
      margin-top: 15px;
    }
    
    .strength-meter {
      height: 6px;
      background: var(--gray);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
      position: relative;
    }
    
    .strength-meter::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: var(--strength, 0%);
      background: var(--strength-color, var(--danger));
      transition: width 0.5s var(--ease-out), background 0.5s var(--ease-out);
    }
    
    .strength-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: var(--dark-gray);
    }
    
    /* ===== PHONE INPUT ===== */
    .phone-group {
      display: flex;
      gap: 10px;
    }
    
    .country-selector {
      flex: 0 0 120px;
      position: relative;
    }
    
    .country-selector .input-group {
      cursor: pointer;
    }
    
    .country-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--light);
      border: 1px solid var(--gray);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow);
      max-height: 300px;
      overflow-y: auto;
      display: none;
      z-index: 1000;
      margin-top: 5px;
    }
    
    .country-dropdown.show {
      display: block;
      animation: fadeIn 0.2s var(--ease-out);
    }
    
    .country-option {
      padding: 12px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .country-option:hover {
      background: var(--light-gray);
    }
    
    .country-option.selected {
      background: rgba(58, 134, 255, 0.1);
    }
    
    /* ===== TERMS & CONDITIONS ===== */
    .terms-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
      animation: fadeIn 0.3s var(--ease-out);
    }
    
    .terms-modal.show {
      display: flex;
    }
    
    .terms-content {
      background: var(--light);
      border-radius: var(--radius);
      padding: 30px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
      animation: slideIn 0.3s var(--ease-out);
    }
    
    .terms-content h2 {
      margin-bottom: 20px;
      color: var(--text);
    }
    
    /* ===== BUTTONS ===== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 18px 32px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      font-family: 'Poppins', sans-serif;
      letter-spacing: 0.3px;
      text-decoration: none;
      user-select: none;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.7s var(--ease-out);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .btn-secondary {
      background: var(--light-gray);
      color: var(--text);
      border: 2px solid var(--gray);
    }
    
    .btn-secondary:hover {
      border-color: var(--primary);
    }
    
    .btn-group {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }
    
    .btn-group .btn {
      flex: 1;
    }
    
    /* ===== NOTIFICATIONS SYSTEM ===== */
    .notification-system {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 400px;
    }
    
    .notification {
      padding: 20px;
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-elevated);
      display: flex;
      align-items: flex-start;
      gap: 15px;
      animation: slideIn 0.4s var(--ease-out);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.95);
      border-left: 4px solid var(--primary);
    }
    
    @media (prefers-color-scheme: dark) {
      .notification {
        background: rgba(30, 41, 59, 0.95);
      }
    }
    
    .notification.success {
      border-left-color: var(--success);
    }
    
    .notification.error {
      border-left-color: var(--danger);
    }
    
    .notification.warning {
      border-left-color: var(--warning);
    }
    
    .notification-info {
      flex: 1;
    }
    
    .notification-title {
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--text);
    }
    
    .notification-message {
      color: var(--text-light);
      font-size: 0.95rem;
      line-height: 1.5;
    }
    
    .notification-close {
      background: none;
      border: none;
      color: var(--dark-gray);
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
      transition: var(--transition);
      flex-shrink: 0;
    }
    
    .notification-close:hover {
      background: rgba(0, 0, 0, 0.1);
      color: var(--text);
    }
    
    /* ===== LOADING STATES ===== */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ===== FOOTER ===== */
    .footer {
      margin-top: 40px;
      text-align: center;
      color: var(--dark-gray);
      font-size: 0.9rem;
      padding-top: 30px;
      border-top: 1px solid var(--gray);
    }
    
    .footer-links {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 25px;
      flex-wrap: wrap;
    }
    
    .footer-links a {
      color: var(--dark-gray);
      text-decoration: none;
      font-weight: 500;
      transition: var(--transition);
      position: relative;
      padding: 0 5px;
    }
    
    .footer-links a:hover {
      color: var(--primary);
    }
    
    /* ===== TOOLTIPS ===== */
    .tooltip {
      position: absolute;
      background: var(--text);
      color: var(--light);
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      white-space: nowrap;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s var(--ease-out);
      box-shadow: var(--shadow);
    }
    
    .tooltip::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 0 6px 6px 6px;
      border-style: solid;
      border-color: transparent transparent var(--text) transparent;
    }
    
    /* ===== RESPONSIVE DESIGN ===== */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .card {
        padding: 25px;
      }
      
      .logo-text {
        font-size: 2.2rem;
      }
      
      .logo-img {
        height: 60px;
        width: 60px;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      .phone-group {
        flex-direction: column;
      }
      
      .country-selector {
        width: 100%;
      }
    }
    
    @media (max-width: 480px) {
      .card {
        padding: 20px;
      }
      
      .logo-container {
        flex-direction: column;
        text-align: center;
        gap: 10px;
      }
      
      .logo-text {
        font-size: 2rem;
      }
      
      .form-progress::before {
        left: 15%;
        right: 15%;
      }
      
      .step-label {
        font-size: 0.7rem;
      }
    }
    
    /* ===== PRINT STYLES ===== */
    @media print {
      .no-print {
        display: none !important;
      }
      
      body {
        background: white !important;
        color: black !important;
      }
      
      .card {
        box-shadow: none !important;
        border: 1px solid #ddd !important;
      }
    }
  </style>
</head>
<body>
  <!-- Background Elements -->
  <div class="floating-elements">
    <div class="floating-element"></div>
    <div class="floating-element"></div>
    <div class="floating-element"></div>
  </div>
  
  <!-- Fireworks Canvas -->
  <canvas id="fireworks-canvas"></canvas>
  
  <!-- Notifications Container -->
  <div class="notification-system" id="notificationSystem"></div>
  
  <!-- Terms Modal -->
  <div class="terms-modal" id="termsModal">
    <div class="terms-content">
      <h2>Conditions d'utilisation</h2>
      <div id="termsContent">
        <!-- Terms loaded dynamically -->
      </div>
      <div class="btn-group" style="margin-top: 20px;">
        <button class="btn" onclick="closeTermsModal()">J'accepte</button>
        <button class="btn btn-secondary" onclick="closeTermsModal()">Fermer</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Header -->
    <div class="logo-header">
      <div class="logo-container">
        <img src="https://raw.githubusercontent.com/exaucenapopolo/EARNESIA-GROUP/refs/heads/main/c8f725a49c3742ea90f599a9ca96329a.jpg" 
             alt="EARNESIA Logo" 
             class="logo-img"
             loading="lazy">
        <span class="logo-text">EARNESIA</span>
      </div>
      <div class="tagline">Ton futur en route</div>
    </div>

    <!-- Form Progress -->
    <div class="form-progress">
      <div class="progress-step active" data-step="1">
        <span>1</span>
        <div class="step-label">Informations</div>
      </div>
      <div class="progress-step" data-step="2">
        <span>2</span>
        <div class="step-label">Contact</div>
      </div>
      <div class="progress-step" data-step="3">
        <span>3</span>
        <div class="step-label">S√©curit√©</div>
      </div>
      <div class="progress-step" data-step="4">
        <span>4</span>
        <div class="step-label">Confirmation</div>
      </div>
    </div>

    <!-- Main Card -->
    <div class="card">
      <!-- Form Sections -->
      <form id="registrationForm">
        <!-- Step 1: Personal Info -->
        <div class="form-section active" data-section="1">
          <div class="card-header">
            <h1>Informations personnelles</h1>
            <p>Commencez par remplir vos informations de base</p>
          </div>
          
          <div class="form-group">
            <label for="username">Nom d'utilisateur *</label>
            <div class="input-container">
              <div class="input-group">
                <div class="input-icon"><i class="fas fa-user"></i></div>
                <input type="text" 
                       id="username" 
                       name="username" 
                       required 
                       placeholder="Choisissez votre nom d'utilisateur"
                       autocomplete="username"
                       minlength="3"
                       maxlength="20">
              </div>
              <div class="tooltip" id="usernameTooltip"></div>
            </div>
            <div class="input-hint" id="usernameHint"></div>
          </div>

          <div class="form-group">
            <label for="par">Parrain (optionnel)</label>
            <div class="input-container">
              <div class="input-group" id="parInputGroup">
                <div class="input-icon"><i class="fas fa-user-friends"></i></div>
                <input type="text" 
                       id="par" 
                       name="par" 
                       placeholder="Aucun parrain d√©tect√©" 
                       disabled
                       autocomplete="off">
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2: Contact Info -->
        <div class="form-section" data-section="2">
          <div class="card-header">
            <h1>Coordonn√©es</h1>
            <p>Comment pouvons-nous vous contacter ?</p>
          </div>
          
          <div class="form-group">
            <label for="email">Adresse e-mail *</label>
            <div class="input-container">
              <div class="input-group">
                <div class="input-icon"><i class="fas fa-envelope"></i></div>
                <input type="email" 
                       id="email" 
                       name="email" 
                       required 
                       placeholder="exemple@email.com"
                       autocomplete="email">
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="firstName">Pr√©nom *</label>
            <div class="input-container">
              <div class="input-group">
                <div class="input-icon"><i class="fas fa-user-circle"></i></div>
                <input type="text" 
                       id="firstName" 
                       name="firstName" 
                       required 
                       placeholder="Votre pr√©nom"
                       autocomplete="given-name">
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="lastName">Nom de famille *</label>
            <div class="input-container">
              <div class="input-group">
                <div class="input-icon"><i class="fas fa-user-tag"></i></div>
                <input type="text" 
                       id="lastName" 
                       name="lastName" 
                       required 
                       placeholder="Votre nom de famille"
                       autocomplete="family-name">
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="country">Pays *</label>
            <div class="input-container">
              <div class="country-selector">
                <div class="input-group" id="countrySelector">
                  <div class="input-icon"><i class="fas fa-globe"></i></div>
                  <input type="text" 
                         id="countryDisplay" 
                         placeholder="S√©lectionnez votre pays" 
                         readonly>
                  <input type="hidden" id="country" name="country">
                  <input type="hidden" id="countryCode" name="countryCode">
                  <i class="fas fa-chevron-down" style="margin-right: 15px;"></i>
                </div>
                <div class="country-dropdown" id="countryDropdown">
                  <!-- Countries loaded dynamically -->
                </div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="phone">Num√©ro de t√©l√©phone *</label>
            <div class="input-container">
              <div class="input-group phone-group">
                <div class="input-icon"><i class="fas fa-phone"></i></div>
                <input type="tel" 
                       id="phone" 
                       name="phone" 
                       required 
                       placeholder="XX XXX XXX"
                       autocomplete="tel">
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: Security -->
        <div class="form-section" data-section="3">
          <div class="card-header">
            <h1>S√©curit√© du compte</h1>
            <p>Prot√©gez votre compte avec un mot de passe solide</p>
          </div>
          
          <div class="form-group">
            <label for="password">Mot de passe *</label>
            <div class="input-container">
              <div class="input-group">
                <div class="input-icon"><i class="fas fa-lock"></i></div>
                <input type="password" 
                       id="password" 
                       name="password" 
                       required 
                       placeholder="Cr√©ez un mot de passe s√©curis√©"
                       autocomplete="new-password"
                       minlength="8">
                <button type="button" 
                        class="password-toggle" 
                        onclick="togglePassword('password')">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
            <div class="password-strength">
              <div class="strength-meter" id="strengthMeter"></div>
              <div class="strength-labels">
                <span>Faible</span>
                <span>Fort</span>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="confirmPassword">Confirmez le mot de passe *</label>
            <div class="input-container">
              <div class="input-group">
                <div class="input-icon"><i class="fas fa-lock"></i></div>
                <input type="password" 
                       id="confirmPassword" 
                       name="confirmPassword" 
                       required 
                       placeholder="Confirmez votre mot de passe"
                       autocomplete="new-password">
                <button type="button" 
                        class="password-toggle" 
                        onclick="togglePassword('confirmPassword')">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="human" name="human" required>
              <label for="human" class="terms-text">I am human</label>
            </div>
            <div class="terms-text" style="margin-top: 10px; text-align: center; font-size: 0.8rem;">
              <strong>hCaptcha</strong> - <a href="#" onclick="openPrivacyModal()">Privacy</a> - <a href="#" onclick="openTermsModal()">Terms</a>
            </div>
          </div>
        </div>

        <!-- Step 4: Confirmation -->
        <div class="form-section" data-section="4">
          <div class="card-header">
            <h1>Confirmation</h1>
            <p>V√©rifiez vos informations avant de finaliser</p>
          </div>
          
          <div class="summary" id="registrationSummary">
            <!-- Summary loaded dynamically -->
          </div>

          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="terms" name="terms" required>
              <div class="terms-text">
                J'accepte les <a href="#" onclick="openTermsModal()">Conditions d'utilisation</a> 
                et la <a href="#" onclick="openPrivacyModal()">Politique de confidentialit√©</a> de EARNESIA.<br>
                Mon compte devra √™tre activ√© <strong>apr√®s mon paiement</strong>.
              </div>
            </div>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="btn-group">
          <button type="button" 
                  class="btn btn-secondary" 
                  id="prevBtn" 
                  onclick="previousStep()" 
                  style="display: none;">
            <i class="fas fa-arrow-left"></i> Pr√©c√©dent
          </button>
          <button type="button" 
                  class="btn" 
                  id="nextBtn" 
                  onclick="nextStep()">
            Suivant <i class="fas fa-arrow-right"></i>
          </button>
          <button type="submit" 
                  class="btn" 
                  id="submitBtn" 
                  style="display: none;">
            <i class="fas fa-user-plus"></i> Cr√©er mon compte
          </button>
        </div>
      </form>

      <!-- Login Link -->
      <div class="login-link">
        Vous avez d√©j√† un compte? <a href="login.html">Connectez-vous</a>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <div>¬© 2025 EARNESIA GROUP. Tous droits r√©serv√©s.</div>
      <div class="footer-links">
        <a href="#" onclick="openTermsModal()">Conditions d'utilisation</a>
        <a href="#" onclick="openPrivacyModal()">Politique de confidentialit√©</a>
        <a href="support.html">Support</a>
        <a href="https://social-boost-horizon-new-sbh.vercel.app" target="_blank">Propuls√© par SHB</a>
      </div>
    </div>
  </div>

  <script type="module">
    // ===== MODULE IMPORTS =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      updateProfile,
      sendEmailVerification
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";

    // ===== FIREBASE CONFIGURATION =====
    const firebaseConfig = {
      apiKey: "AIzaSyCjGisjgbFc2ZE0BFgdhlUao8bCCeuKP1k",
      authDomain: "cash-flowr.firebaseapp.com",
      projectId: "cash-flowr",
      storageBucket: "cash-flowr.firebasestorage.app",
      messagingSenderId: "1091928501310",
      appId: "1:1091928501310:web:4f4de306cde36f378ff56f",
      measurementId: "G-5SF6VDLZCB"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const analytics = getAnalytics(app);

    // Server configuration
    const SERVER_URL = "https://mulaflowr-exaucenapopolo2.replit.app";
    const API_RATE_LIMIT = 10000; // 10 seconds

    // ===== APPLICATION STATE =====
    let appState = {
      currentStep: 1,
      totalSteps: 4,
      sponsorData: null,
      formData: {},
      lastRequest: 0,
      isSubmitting: false,
      passwordStrength: 0
    };

    // ===== SECURITY HELPER =====
    const Security = {
      sanitize(input) {
        if (typeof input !== 'string') return input;
        const div = document.createElement('div');
        div.textContent = input;
        return div.innerHTML;
      },

      validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
      },

      validatePhone(phone) {
        const re = /^[0-9\s\-\(\)]+$/;
        return re.test(phone) && phone.replace(/\D/g, '').length >= 8;
      },

      validatePassword(password) {
        const requirements = {
          length: password.length >= 8,
          uppercase: /[A-Z]/.test(password),
          lowercase: /[a-z]/.test(password),
          number: /[0-9]/.test(password),
          special: /[^A-Za-z0-9]/.test(password)
        };

        const score = Object.values(requirements).filter(Boolean).length;
        const strength = (score / 5) * 100;

        return {
          valid: score >= 3,
          score,
          strength,
          requirements
        };
      },

      calculatePasswordStrength(password) {
        const validation = this.validatePassword(password);
        appState.passwordStrength = validation.strength;
        
        const meter = document.getElementById('strengthMeter');
        if (meter) {
          let color = '#ff6b6b';
          if (validation.strength >= 60) color = '#ffd166';
          if (validation.strength >= 80) color = '#00cc88';
          
          meter.style.setProperty('--strength', `${validation.strength}%`);
          meter.style.setProperty('--strength-color', color);
        }

        return validation;
      }
    };

    // ===== UI NOTIFICATION SYSTEM =====
    class NotificationSystem {
      constructor() {
        this.container = document.getElementById('notificationSystem');
        this.queue = [];
        this.isShowing = false;
      }

      show(type, title, message, duration = 5000) {
        const notification = {
          id: Date.now(),
          type,
          title,
          message,
          duration,
          timestamp: Date.now()
        };

        this.queue.push(notification);
        this.processQueue();
      }

      processQueue() {
        if (this.isShowing || this.queue.length === 0) return;

        this.isShowing = true;
        const notification = this.queue.shift();
        this.createNotification(notification);
      }

      createNotification(notification) {
        const element = document.createElement('div');
        element.className = `notification ${notification.type}`;
        element.innerHTML = `
          <div class="notification-icon">
            <i class="fas ${this.getIcon(notification.type)}"></i>
          </div>
          <div class="notification-info">
            <div class="notification-title">${notification.title}</div>
            <div class="notification-message">${notification.message}</div>
          </div>
          <button class="notification-close">
            <i class="fas fa-times"></i>
          </button>
        `;

        this.container.appendChild(element);

        const closeBtn = element.querySelector('.notification-close');
        closeBtn.addEventListener('click', () => this.closeNotification(element));

        setTimeout(() => {
          this.closeNotification(element);
        }, notification.duration);
      }

      closeNotification(element) {
        element.style.transform = 'translateX(100%)';
        element.style.opacity = '0';
        
        setTimeout(() => {
          if (element.parentNode) {
            element.parentNode.removeChild(element);
          }
          this.isShowing = false;
          this.processQueue();
        }, 300);
      }

      getIcon(type) {
        const icons = {
          success: 'fa-check-circle',
          error: 'fa-exclamation-circle',
          warning: 'fa-exclamation-triangle',
          info: 'fa-info-circle'
        };
        return icons[type] || 'fa-info-circle';
      }

      success(message, title = 'Succ√®s') {
        this.show('success', title, message);
      }

      error(message, title = 'Erreur') {
        this.show('error', title, message);
      }

      warning(message, title = 'Attention') {
        this.show('warning', title, message);
      }

      info(message, title = 'Information') {
        this.show('info', title, message);
      }
    }

    const notifications = new NotificationSystem();

    // ===== FORM STEP MANAGEMENT =====
    class FormManager {
      constructor() {
        this.currentStep = 1;
        this.steps = document.querySelectorAll('.form-section');
        this.progressSteps = document.querySelectorAll('.progress-step');
        this.init();
      }

      init() {
        this.updateUI();
        this.setupEventListeners();
      }

      next() {
        if (!this.validateCurrentStep()) return false;
        
        if (this.currentStep < this.steps.length) {
          this.steps[this.currentStep - 1].classList.remove('active');
          this.progressSteps[this.currentStep - 1].classList.remove('active');
          
          this.currentStep++;
          
          this.steps[this.currentStep - 1].classList.add('active');
          this.progressSteps[this.currentStep - 1].classList.add('active');
          this.progressSteps[this.currentStep - 2].classList.add('completed');
          
          this.updateUI();
          this.saveFormData();
          return true;
        }
        return false;
      }

      previous() {
        if (this.currentStep > 1) {
          this.steps[this.currentStep - 1].classList.remove('active');
          this.progressSteps[this.currentStep - 1].classList.remove('active');
          
          this.currentStep--;
          
          this.steps[this.currentStep - 1].classList.add('active');
          this.progressSteps[this.currentStep - 1].classList.add('active');
          this.progressSteps[this.currentStep].classList.remove('completed');
          
          this.updateUI();
          return true;
        }
        return false;
      }

      validateCurrentStep() {
        const currentStepElement = this.steps[this.currentStep - 1];
        const inputs = currentStepElement.querySelectorAll('input[required], select[required]');
        
        let isValid = true;
        
        inputs.forEach(input => {
          if (!input.value.trim()) {
            this.highlightError(input, 'Ce champ est requis');
            isValid = false;
          } else if (input.type === 'email' && !Security.validateEmail(input.value)) {
            this.highlightError(input, 'Format d\'email invalide');
            isValid = false;
          }
        });

        if (this.currentStep === 3) {
          const password = document.getElementById('password').value;
          const confirmPassword = document.getElementById('confirmPassword').value;
          
          const passwordValidation = Security.validatePassword(password);
          if (!passwordValidation.valid) {
            notifications.error('Le mot de passe doit contenir au moins 8 caract√®res, une majuscule, une minuscule et un chiffre');
            isValid = false;
          }
          
          if (password !== confirmPassword) {
            this.highlightError(document.getElementById('confirmPassword'), 'Les mots de passe ne correspondent pas');
            isValid = false;
          }
        }

        return isValid;
      }

      highlightError(input, message) {
        const group = input.closest('.input-group');
        group.classList.add('error');
        
        notifications.error(message);
        
        setTimeout(() => {
          group.classList.remove('error');
        }, 3000);
      }

      updateUI() {
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        
        if (this.currentStep === 1) {
          prevBtn.style.display = 'none';
        } else {
          prevBtn.style.display = 'inline-flex';
        }
        
        if (this.currentStep === this.steps.length) {
          nextBtn.style.display = 'none';
          submitBtn.style.display = 'inline-flex';
          this.updateSummary();
        } else {
          nextBtn.style.display = 'inline-flex';
          submitBtn.style.display = 'none';
        }
      }

      updateSummary() {
        const summary = document.getElementById('registrationSummary');
        if (!summary) return;
        
        const formData = this.getAllFormData();
        
        summary.innerHTML = `
          <div class="summary-grid">
            <div class="summary-item">
              <span class="summary-label">Nom d'utilisateur:</span>
              <span class="summary-value">${Security.sanitize(formData.username)}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Email:</span>
              <span class="summary-value">${Security.sanitize(formData.email)}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Nom complet:</span>
              <span class="summary-value">${Security.sanitize(formData.firstName)} ${Security.sanitize(formData.lastName)}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Pays:</span>
              <span class="summary-value">${Security.sanitize(formData.countryDisplay)}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">T√©l√©phone:</span>
              <span class="summary-value">${Security.sanitize(formData.phone)}</span>
            </div>
          </div>
        `;
      }

      getAllFormData() {
        const data = {};
        const form = document.getElementById('registrationForm');
        const inputs = form.querySelectorAll('input, select, textarea');
        
        inputs.forEach(input => {
          if (input.name) {
            data[input.name] = input.value;
          }
        });
        
        data.countryDisplay = document.getElementById('countryDisplay').value;
        
        return data;
      }

      saveFormData() {
        const data = this.getAllFormData();
        localStorage.setItem('earnesia_registration_data', JSON.stringify(data));
      }

      loadFormData() {
        const saved = localStorage.getItem('earnesia_registration_data');
        if (saved) {
          try {
            const data = JSON.parse(saved);
            Object.keys(data).forEach(key => {
              const input = document.querySelector(`[name="${key}"]`);
              if (input) input.value = data[key];
            });
          } catch (e) {
            console.warn('Could not load saved form data:', e);
          }
        }
      }

      setupEventListeners() {
        // Auto-save on input
        const inputs = document.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
          input.addEventListener('input', () => this.saveFormData());
        });
      }

      goToStep(step) {
        if (step < 1 || step > this.steps.length) return;
        
        this.currentStep = step;
        this.steps.forEach((s, index) => {
          s.classList.toggle('active', index === step - 1);
        });
        
        this.progressSteps.forEach((p, index) => {
          p.classList.toggle('active', index === step - 1);
          p.classList.toggle('completed', index < step - 1);
        });
        
        this.updateUI();
      }
    }

    const formManager = new FormManager();

    // ===== COUNTRY SELECTOR =====
    class CountrySelector {
      constructor() {
        this.countries = [
          // Africa
          { code: 'cm', name: 'Cameroun', flag: 'üá®üá≤', phoneCode: '+237' },
          { code: 'ci', name: 'C√¥te d\'Ivoire', flag: 'üá®üáÆ', phoneCode: '+225' },
          { code: 'sn', name: 'S√©n√©gal', flag: 'üá∏üá≥', phoneCode: '+221' },
          { code: 'ng', name: 'Nigeria', flag: 'üá≥üá¨', phoneCode: '+234' },
          { code: 'gh', name: 'Ghana', flag: 'üá¨üá≠', phoneCode: '+233' },
          { code: 'ke', name: 'Kenya', flag: 'üá∞üá™', phoneCode: '+254' },
          { code: 'za', name: 'Afrique du Sud', flag: 'üáøüá¶', phoneCode: '+27' },
          
          // Other regions
          { code: 'fr', name: 'France', flag: 'üá´üá∑', phoneCode: '+33' },
          { code: 'us', name: 'USA', flag: 'üá∫üá∏', phoneCode: '+1' },
          { code: 'gb', name: 'UK', flag: 'üá¨üáß', phoneCode: '+44' },
          { code: 'ca', name: 'Canada', flag: 'üá®üá¶', phoneCode: '+1' },
          { code: 'de', name: 'Allemagne', flag: 'üá©üá™', phoneCode: '+49' }
        ];
        
        this.init();
      }

      init() {
        this.renderDropdown();
        this.setupEventListeners();
        this.selectCountry('cm'); // Default to Cameroon
      }

      renderDropdown() {
        const dropdown = document.getElementById('countryDropdown');
        if (!dropdown) return;

        dropdown.innerHTML = this.countries.map(country => `
          <div class="country-option" 
               data-code="${country.code}" 
               data-phone="${country.phoneCode}"
               onclick="countrySelector.selectCountry('${country.code}')">
            <span class="country-flag">${country.flag}</span>
            <span class="country-name">${country.name}</span>
            <span class="country-code">${country.phoneCode}</span>
          </div>
        `).join('');
      }

      selectCountry(countryCode) {
        const country = this.countries.find(c => c.code === countryCode);
        if (!country) return;

        const display = document.getElementById('countryDisplay');
        const hidden = document.getElementById('country');
        const phoneCode = document.getElementById('countryCode');
        const dropdown = document.getElementById('countryDropdown');

        if (display) display.value = `${country.flag} ${country.name}`;
        if (hidden) hidden.value = country.code;
        if (phoneCode) phoneCode.value = country.phoneCode;

        if (dropdown) dropdown.classList.remove('show');

        // Update phone placeholder based on country
        const phoneInput = document.getElementById('phone');
        if (phoneInput) {
          switch(countryCode) {
            case 'cm': phoneInput.placeholder = '6XX XXX XXX'; break;
            case 'ci': phoneInput.placeholder = '0X XX XX XX'; break;
            case 'fr': phoneInput.placeholder = '6 XX XX XX XX'; break;
            default: phoneInput.placeholder = 'XX XXX XXXX';
          }
        }

        // Log analytics
        logEvent(analytics, 'country_selected', {
          country_code: countryCode,
          country_name: country.name
        });
      }

      setupEventListeners() {
        const selector = document.getElementById('countrySelector');
        const dropdown = document.getElementById('countryDropdown');

        if (selector && dropdown) {
          selector.addEventListener('click', (e) => {
            e.stopPropagation();
            dropdown.classList.toggle('show');
          });

          document.addEventListener('click', () => {
            dropdown.classList.remove('show');
          });
        }
      }

      searchCountry(query) {
        return this.countries.filter(country => 
          country.name.toLowerCase().includes(query.toLowerCase()) ||
          country.code.toLowerCase().includes(query.toLowerCase())
        );
      }
    }

    const countrySelector = new CountrySelector();

    // ===== FIREWORKS ANIMATION =====
    class Fireworks {
      constructor() {
        this.canvas = document.getElementById('fireworks-canvas');
        if (!this.canvas) return;
        
        this.ctx = this.canvas.getContext('2d');
        this.particles = [];
        this.isActive = false;
        
        this.resizeCanvas();
        window.addEventListener('resize', () => this.resizeCanvas());
      }

      resizeCanvas() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
      }

      launch() {
        if (!this.canvas) return;
        
        this.isActive = true;
        this.canvas.style.display = 'block';
        
        // Create multiple explosions
        for (let i = 0; i < 5; i++) {
          setTimeout(() => this.createExplosion(
            Math.random() * this.canvas.width,
            Math.random() * this.canvas.height / 2 + this.canvas.height / 4
          ), i * 300);
        }
        
        // Stop after 5 seconds
        setTimeout(() => {
          this.isActive = false;
          setTimeout(() => {
            if (!this.isActive) {
              this.canvas.style.display = 'none';
              this.particles = [];
            }
          }, 2000);
        }, 5000);
        
        this.animate();
      }

      createExplosion(x, y) {
        const colors = [
          '#3a86ff', '#00b4d8', '#00cc88', '#ff6b6b', 
          '#ffd166', '#9d4edd', '#f15bb5'
        ];
        
        const particleCount = 100;
        
        for (let i = 0; i < particleCount; i++) {
          const angle = Math.random() * Math.PI * 2;
          const speed = Math.random() * 5 + 2;
          const radius = Math.random() * 3 + 1;
          const color = colors[Math.floor(Math.random() * colors.length)];
          const life = 100;
          
          this.particles.push({
            x, y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            radius,
            color,
            life,
            maxLife: life,
            gravity: 0.05
          });
        }
      }

      animate() {
        if (!this.isActive && this.particles.length === 0) return;
        
        // Clear canvas with fade effect
        this.ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // Update and draw particles
        for (let i = this.particles.length - 1; i >= 0; i--) {
          const p = this.particles[i];
          
          // Update position
          p.x += p.vx;
          p.y += p.vy;
          p.vy += p.gravity;
          p.life--;
          
          // Draw particle
          this.ctx.beginPath();
          this.ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
          this.ctx.fillStyle = p.color;
          this.ctx.globalAlpha = p.life / p.maxLife;
          this.ctx.fill();
          
          // Remove dead particles
          if (p.life <= 0) {
            this.particles.splice(i, 1);
          }
        }
        
        this.ctx.globalAlpha = 1;
        
        // Continue animation
        if (this.isActive || this.particles.length > 0) {
          requestAnimationFrame(() => this.animate());
        }
      }
    }

    const fireworks = new Fireworks();

    // ===== FORM SUBMISSION =====
    class RegistrationService {
      constructor() {
        this.rateLimit = API_RATE_LIMIT;
      }

      async register(userData) {
        // Rate limiting
        const now = Date.now();
        if (now - appState.lastRequest < this.rateLimit) {
          throw new Error('Veuillez patienter avant de r√©essayer');
        }

        appState.lastRequest = now;

        try {
          // 1. Create Firebase Auth user
          const userCredential = await createUserWithEmailAndPassword(
            auth, 
            userData.email, 
            userData.password
          );
          
          const user = userCredential.user;

          // 2. Update profile
          await updateProfile(user, {
            displayName: `${userData.firstName} ${userData.lastName}`
          });

          // 3. Send email verification
          await sendEmailVerification(user);

          // 4. Get ID token
          const idToken = await user.getIdToken();

          // 5. Save additional data to Firestore
          await this.saveUserData(user.uid, userData, idToken);

          // 6. Send to referral server
          await this.registerWithReferral(user.uid, userData, idToken);

          // Log success
          logEvent(analytics, 'sign_up', {
            method: 'email',
            username: userData.username
          });

          return { success: true, userId: user.uid };

        } catch (error) {
          console.error('Registration error:', error);
          throw this.handleFirebaseError(error);
        }
      }

      async saveUserData(uid, userData, idToken) {
        const userRef = collection(db, 'users');
        
        await addDoc(userRef, {
          uid,
          username: userData.username,
          email: userData.email,
          firstName: userData.firstName,
          lastName: userData.lastName,
          country: userData.country,
          phone: userData.phone,
          sponsor: appState.sponsorData?.username || null,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          status: 'pending_activation',
          emailVerified: false
        });
      }

      async registerWithReferral(uid, userData, idToken) {
        const response = await fetch(`${SERVER_URL}/api/register-with-referral`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${idToken}`
          },
          body: JSON.stringify({
            uid,
            email: userData.email,
            displayName: userData.username,
            firstName: userData.firstName,
            lastName: userData.lastName,
            sponsorUsername: appState.sponsorData?.username || '',
            country: userData.country,
            phoneNumber: `${userData.countryCode}${userData.phone}`
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Erreur serveur');
        }

        return await response.json();
      }

      handleFirebaseError(error) {
        const errorMap = {
          'auth/email-already-in-use': 'Cette adresse email est d√©j√† utilis√©e',
          'auth/invalid-email': 'Adresse email invalide',
          'auth/operation-not-allowed': 'Op√©ration non autoris√©e',
          'auth/weak-password': 'Mot de passe trop faible (minimum 6 caract√®res)',
          'auth/network-request-failed': 'Erreur r√©seau. V√©rifiez votre connexion'
        };

        return new Error(errorMap[error.code] || error.message);
      }
    }

    const registrationService = new RegistrationService();

    // ===== SPONSOR VALIDATION =====
    async function validateSponsor(username) {
      if (!username) return null;

      try {
        const usersRef = collection(db, 'users');
        const q = query(usersRef, where('username', '==', username.trim()));
        const snapshot = await getDocs(q);

        if (!snapshot.empty) {
          const doc = snapshot.docs[0];
          return {
            uid: doc.id,
            username: doc.data().username,
            displayName: doc.data().displayName || doc.data().username
          };
        }
        return null;
      } catch (error) {
        console.error('Sponsor validation error:', error);
        return null;
      }
    }

    // ===== USERNAME AVAILABILITY =====
    async function checkUsernameAvailability(username) {
      if (!username || username.length < 3) return false;

      try {
        const usersRef = collection(db, 'users');
        const q = query(usersRef, where('username', '==', username.trim()));
        const snapshot = await getDocs(q);
        return snapshot.empty;
      } catch (error) {
        console.error('Username check error:', error);
        return false;
      }
    }

    // ===== EVENT HANDLERS =====
    window.nextStep = function() {
      formManager.next();
    };

    window.previousStep = function() {
      formManager.previous();
    };

    window.togglePassword = function(inputId) {
      const input = document.getElementById(inputId);
      const toggle = input.nextElementSibling;
      
      if (input.type === 'password') {
        input.type = 'text';
        toggle.innerHTML = '<i class="fas fa-eye-slash"></i>';
      } else {
        input.type = 'password';
        toggle.innerHTML = '<i class="fas fa-eye"></i>';
      }
    };

    window.openTermsModal = function() {
      const modal = document.getElementById('termsModal');
      const content = document.getElementById('termsContent');
      
      content.innerHTML = `
        <h3>Conditions G√©n√©rales d'Utilisation</h3>
        <p>Derni√®re mise √† jour: ${new Date().toLocaleDateString('fr-FR')}</p>
        
        <h4>1. Acceptation des conditions</h4>
        <p>En cr√©ant un compte sur EARNESIA, vous acceptez les pr√©sentes conditions d'utilisation...</p>
        
        <!-- Add more terms content -->
      `;
      
      modal.classList.add('show');
    };

    window.closeTermsModal = function() {
      const modal = document.getElementById('termsModal');
      modal.classList.remove('show');
    };

    // ===== FORM SUBMISSION =====
    document.getElementById('registrationForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (appState.isSubmitting) return;
      
      appState.isSubmitting = true;
      
      const submitBtn = document.getElementById('submitBtn');
      const originalText = submitBtn.innerHTML;
      
      submitBtn.innerHTML = '<span class="loading"></span> Cr√©ation en cours...';
      submitBtn.disabled = true;

      try {
        // Collect all form data
        const formData = formManager.getAllFormData();
        
        // Validate final step
        if (!formManager.validateCurrentStep()) {
          throw new Error('Veuillez corriger les erreurs dans le formulaire');
        }

        // Check terms acceptance
        if (!document.getElementById('terms').checked) {
          throw new Error('Vous devez accepter les conditions d\'utilisation');
        }

        // Check human verification
        if (!document.getElementById('human').checked) {
          throw new Error('Veuillez confirmer que vous √™tes humain');
        }

        // Register user
        await registrationService.register(formData);

        // Success animation and redirect
        submitBtn.innerHTML = '<i class="fas fa-check"></i> Compte cr√©√© !';
        submitBtn.classList.add('success-animation');
        
        notifications.success('Compte cr√©√© avec succ√®s ! Redirection vers la page de paiement...');
        fireworks.launch();
        
        setTimeout(() => {
          window.location.href = 'paiement.html';
        }, 3000);

      } catch (error) {
        notifications.error(error.message);
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        appState.isSubmitting = false;
      }
    });

    // ===== REAL-TIME VALIDATION =====
    document.getElementById('username').addEventListener('input', async function() {
      const username = this.value.trim();
      const hint = document.getElementById('usernameHint');
      
      if (username.length < 3) {
        hint.textContent = 'Minimum 3 caract√®res';
        hint.style.color = '#ff6b6b';
        return;
      }

      const available = await checkUsernameAvailability(username);
      
      if (available) {
        hint.textContent = '‚úì Nom d\'utilisateur disponible';
        hint.style.color = '#00cc88';
      } else {
        hint.textContent = '‚úó Ce nom est d√©j√† pris';
        hint.style.color = '#ff6b6b';
      }
    });

    document.getElementById('password').addEventListener('input', function() {
      Security.calculatePasswordStrength(this.value);
    });

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', async function() {
      // Load saved form data
      formManager.loadFormData();
      
      // Check for referral parameter
      const urlParams = new URLSearchParams(window.location.search);
      const refParam = urlParams.get('ref') || urlParams.get('par') || '';
      
      if (refParam) {
        const sponsor = await validateSponsor(refParam);
        if (sponsor) {
          appState.sponsorData = sponsor;
          document.getElementById('par').value = sponsor.displayName;
          notifications.info(`Parrain d√©tect√©: ${sponsor.displayName}`);
        }
      }

      // Initialize analytics
      logEvent(analytics, 'page_view', {
        page_title: 'Inscription',
        page_location: window.location.href
      });

      // Add keyboard navigation
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.type !== 'textarea') {
          if (formManager.currentStep < formManager.steps.length) {
            nextStep();
          }
        }
        
        if (e.key === 'Escape') {
          closeTermsModal();
        }
      });

      // Service Worker registration for PWA
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
          .then(() => console.log('Service Worker registered'))
          .catch(err => console.log('Service Worker registration failed:', err));
      }

      // Add offline detection
      window.addEventListener('online', () => {
        notifications.info('Vous √™tes de nouveau en ligne');
      });

      window.addEventListener('offline', () => {
        notifications.warning('Vous √™tes hors ligne. Certaines fonctionnalit√©s peuvent √™tre limit√©es.');
      });
    });

    // ===== GLOBAL UTILITIES =====
    window.copyToClipboard = function(text) {
      navigator.clipboard.writeText(text)
        .then(() => notifications.success('Copi√© dans le presse-papier'))
        .catch(() => notifications.error('√âchec de la copie'));
    };

    window.generateRandomPassword = function() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
      let password = '';
      
      for (let i = 0; i < 12; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      
      document.getElementById('password').value = password;
      document.getElementById('confirmPassword').value = password;
      Security.calculatePasswordStrength(password);
    };

    // Expose for debugging
    window.appState = appState;
    window.formManager = formManager;
  </script>

  <!-- Service Worker for PWA -->
  <script>
    if ('serviceWorker' in navigator) {
      const swCode = `
        self.addEventListener('install', event => {
          event.waitUntil(
            caches.open('earnesia-v1').then(cache => {
              return cache.addAll([
                '/',
                '/index.html',
                '/styles.css',
                '/app.js'
              ]);
            })
          );
        });

        self.addEventListener('fetch', event => {
          event.respondWith(
            caches.match(event.request).then(response => {
              return response || fetch(event.request);
            })
          );
        });
      `;

      const blob = new Blob([swCode], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(blob);

      navigator.serviceWorker.register(swUrl)
        .catch(err => console.error('SW registration failed:', err));
    }
  </script>
</body>
</html>